# 数据库

## ORM 连接数据库 桥梁

- TypeORM 对 非关系型数据库不够支持
- Prisma 操作方便，对关系型数据库支持不够丰富

```lua
         TypeORM     MySQL PostgreSQL  SQLite  MariaDB  Sap  Spanner
                     cockroackdb capacitor  cordova  react-native  nativescript  sqljs
                     oracle  mssql aurora-mysql aurora-postgres expo  better-sqlite3
                     MongoDB 5+

nestjs   Prisma      MySQL 5.6+  MariaDB 10+ SQLite  Microsoft SQL Server 2017/19/22
                     PostgreSQL 10+  MongoDB 4.2+

         Mongoose    MongoDB *
```

```lua
                    1. 成本敏感
                    2. 数据量适中
                    3. 安全性需求不高
                    4. 快速开发与部署
           单库    - - - - - - - - - - - - - - - - - - 》 ORM - - >  一种数据库
                    1. 性能受限
                    2. 扩展性有限
                    3. 故障风险
nestjs
                    1. 自定义的需求高
                    2. 数据量大
                    3. 安全性需求高                        ORM1 - - >   一种数据库，多库读写分离
                    4. 合规和法规要求（物理隔离）
          多库    - - - - - - - - - - - -  - - - - - 》
                    1. 架构复杂，部署和维护成本较高
                    2. 数据一致性问题。                     ORM2 - - >  多种数据库，多库
                    3. 分布式事务处理较为复杂
```

## Prisma 使用

1. 第三方库

```sh
pnpm i prisma --save-dev
pnpm i @prisma/client --save
```

2. 初始化

```sh
npx prisma init

# 创建模型后
# 生成模型 ts 类型提示，搭配client使用
npx prisma db push
npx prisma generate

# 生成迁移文件,
# 根据migrate中内容，可以推送到数据库中，也可以进行回退
npx prisma migrate dev --name initial-migration
# 重置
npx prisma migrate reset
# 跳过某些migration怎么处理
npx prisma migrate resolve --applied 20223223222_role
npx prisma migrate deploy
```

3. 创建文件

```sh
nest g mo database/prisma --no-spec
nest g s database/prisma --flag --no-spec
```

## TypeORM 使用

```sh
pnpm i --save @nestjs/typeorm typeorm mysql2
```

```ts
TypeOrmModule.forRootAsync({
      inject: [ConfigService],
      useFactory: (configService: ConfigService) =>
        ({
          type: configService.get('DB_TYPE'),
          host: configService.get('DB_HOST'),
          port: configService.get('DB_PROT'),
          username: configService.get('DB_USERNAME'),
          password: configService.get('DB_PASSWORD'),
          database: configService.get('DB_DATABASE'),
          autoLoadEntities: Boolean(configService.get('DB_AUTOLOAD')) || false,
          synchronize: Boolean(configService.get('DB_SYNC')) || false,
        }) as TypeOrmModuleOptions,
    }),
TypeOrmModule.forFeature([User]),
```

## mongodb 使用

```sh
pnpm i @nestjs/mongoose mongoose
```

```sh
# -f 不是默认名称，需要制定文件名
# -d 启动后，后台运行
docker compose -f docker-compose.mongo.yaml up -d

# 查看信息
docker ps | grep mongo

# exec 进入 sh
docker exec -it nestjs-demo-mongo-1 mongosh -u root -p example

# ERROR [MongooseModule] Unable to connect to the database, Retrying (1)...
# 给 root 分配权限  MongoServerError: Command find requires authentication
test> show dbs
test> use testdb
nest> db.createUser({user:'root', pwd:'example',roles:[{role:'dbOwner',db:'testdb'}]})
# 查看链接数
nest> db.serverStatus().connections
```

## DynamicModule 动态模块写法

```lua
请求  - - param1  - -          单ORM库        - - - - > MySQL
                    | - - > Prisma/TypeORM  |
请求  - - param2  - -                        - - - - > Postgresql
```

## 连接池

```lua

              extra 属性
TypeORM - - - - - - - - - - - >   数据库1  |
            max 连接池： 10                |
                                          | - > 关系型数据库
            连接限制                       |
Prisma - - - - - - - - - - - >   数据库2   |
        num_physical_cpus * 2 + 1         |


               poolSize
Mongoose  - - - - - - - - - >     数据库3  文档型&非关系型
```

## Prisma 多数据库 生成后, 将生成的client 连接进入 项目中

```sh
npx prisma generate
pnpm add prisma-mysql@link:./prisma/client/mysql
```

## 查看数据库有多少个链接

```sh
docker ps | grep postgresql
docker exec -it nestjs-demo-db2-1 /bin/bash
# 进入数据库
ee59:/# > psql -U pguser -d testdb
testdb=# > SELECT count(*) FROM pg_stat_activity;
```

## 将数据库连接及初始化逻辑 放到 user.module.ts 里面

```sh
# 测试运行
nest g mo user/user --no-spec --flat --dry-run
# 如果没有问题
nest g mo user/user --no-spec --flat
```
