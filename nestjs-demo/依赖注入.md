# 依赖注入

## 概念

1. 依赖倒置原则(DIP): 抽象不应该依赖实现，实现也不应该依赖实现，实现应该依赖抽象；
2. 依赖注入(dependency injection, 简写为 DI): 依赖是指依靠某种东西来获得支持，将创建对象的任务转移给其他 class,
   并直接使用依赖项的过程，被称为”依赖项注入“；
3. 控制反转(Inversion of Control, 简写为 IoC): 指一个类不应静态配置其依赖项，应有其他一些类从外部进行配置。

## 实例解释

- src/app.controller.ts 文件中

```ts
constructor(private readonly appService: AppService) {}
```

- 在代码中并没有看到实例化这个 AppService 的地方。这里其实是把创建这个实力对象的工作交给了 `nest框架`， 而不是 AppController
  自己来创建这个对象，这就是所谓的 `控制反转`. 而把创建好的 AppService 实力对象作为 AppController 实例化时的参数传给构造器就是 `依赖注入`

## 优点

- 其实 DI 和 IoC 是实现 `依赖倒置原则` 的具体手段， `依赖倒置原则` 是设计模式五大原则 (SOLID) 中的第五项原则。

## 元数据反射

我们知道 ts 中的类型信息是在运行时是不存在的，那运行时是如何`根据参数的类型`注入`对应实例`的？

- 反射。反射就是在运行时动态获取一个对象的一切信息：方法、属性等。特点在于 `动态类型反推导`。不管是在 ts 中，还是在其他类型语言中。
  反射本质在于 元数据。 在 TypeScript 中， 反射的原理是 通过编译阶段 对 对象注入元数据信息，在运行阶段读取注入的元数据，从而
  得到对象信息。

- 元数据反射(Reflect Metadata) 是 ES7 的一个提案，它主要用来在声明的时候添加和读取元数据。要在 ts 中启用元数据反射相关功能需要：

```ts
// npm i reflect-metadata --save
// 在 tsconfig.json 里配置 emitDecoratorMetadata 选项为 true.
```

- 定义元数据

```ts
// 定义一个类的元数据
Reflect.defineMetadata(metadataKey, data, target);
```

- 获取元数据

```ts
// 可以获取类或者方法上定义的元数据
Reflect.getMetadata(metadataKey, target);
Reflect.getMetadata(metadataKey, instance, methodName);
```

- 内置元数据

TypeScript 结合自身语言的特点，为使用了装饰器的代码声明注入了 3 组 元数据:

```ts
design: type - 成员类型;
design: paramtypes - 成员所有参数类型;
design: returntype - 成员返回类型;
```
