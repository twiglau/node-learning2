# 根据读写，进行工况细化

```lua
技术需求
读写比例，方式 - - 技术导向 - >      工况细化    - - - - >        引用及关联
及数量
```

## 考虑业务

- 最频繁的数据查询模式 -> 基于内嵌的文档模型
- 最常用的查询参数 -> 根据业务需求
- 最频繁的数据写入模式 -> 使用引来来避免性能瓶颈
- 读写操作的比例
- 数据量的大小

## 联系人管理应用的分组需求

1. 用于客户营销
2. 有千万级联系人
3. 需要频繁变动分组（group)的信息，如：
   3.1 增加分组
   3.2 修改名称及描述以及营销状态
4. 一个分组可以有百万级联系人
   > 一个分组信息的改动意味着，百万级的 DB 操作

## 解决方案： Group 使用单独的集合

1. 类似于关系型设计
2. 用 id 或者唯一键关联
3. 使用 $lookup 来提供一次查询多表的能力(类似关联)

```lua
//Contacts
name: "GJ Tang",
company: "Tap",
title: "CTO",
portraits: {
  mimetype: "xxx",
  data: "xxx"
},
addresses: {
  { type: "home", ...},
  { type: "work", ...}
},
group_ids: [1,2,3,...]
```

## 引用模式下的关联查询

```lua
// Contacts
name: "TJ Tang",
company: "Tap",
group_dis: [1,2,3, ...]

// Groups
group_id: 1,
name: "Friends"
```

```js
db.contacts.aggregate([
  {
    $lookup: {
      from: "groups",
      localField: "group_ids",
      foreignField: "group_id",
      as: "groups",
    },
  },
]);
```

```json
{
  "_id": ObjectId("ldkalflafkladjkfa"),
  "name": "TJ",
  "company": "Tapdata",
  "group_ids": [1, 3],
  "groups": [
    {
      "_id": ObjectId("xcccc"),
      "name": "Friends",
      "group_id": 1
    },
    {
      "_id": ObjectId("adffd"),
      "name": "Surfers",
      "group_id": 3
    }
  ]
}
```

## 联系人的头像： 引用模式

1. 头像使用高保真，大小在 5MB~10MB
2. 头像一旦上传，一个月不可更换
3. 基础信息查询(不含头像)和头像查询的比例为 9:1
4. 建议： 使用引用方式，把头像数据放到另外一个集合，可以显著提升 90% 的查询效率

```lua
# Contacts
name: "TJ Tang",
company: "Tap",
title: "CTO",
portrait_id: 123,
addresses: [
  {type: "home", ...},
  {type: "work", ...}
]

# Contact_Portrait
_id: 123,
mimetype: "xxx",
data: "xxxx..."
```

## 什么时候该使用 引用方式？

1. 内嵌文档太大，数 MB 或者超过 16MB
2. 内嵌文档或数组元素会频繁修改
3. 内嵌数组元素会持续增长并且没有封顶

## MongoDB 引用设计的限制

1. MongoDB 对使用引用的集合之间并无主外键检查
2. MongoDB 使用聚合框架的 $lookup 来模仿关联查询
3. $lookup 只支持 left outer join
4. $lookup 的关联目标 （from）不能是分片表

```lua
db.contacts.aggregate([
  {
    $lookup: {
      from: "groups",
      localField: "group_ids",
      foreignField: "group_id",
      as: "groups"
    }
  }
])
```
