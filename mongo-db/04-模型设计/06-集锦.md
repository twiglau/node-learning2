# 集锦

## 大文档，很多字段，很多索引

```lua
{
  title: "Dunkirk",
  ...
  release_USA: "2017/07/23",
  release_UK: "2017/08/01",
  release_France: "2017/08/03",
  release_Festival_San_Jose: "2017/09/22"
}

# 需要很多索引
{ release_USA: 1}
{ release_UK: 1}
{ release_France: 1}
...
{ release_Festival_San_Jose: 1}
```

- 解决方案： 列转行
  `db.movies.createIndex({"releases.country":1, "releases.date":1})`

```lua
{
  title: "Dunkirk",
  ...
  releases: [
    { country: "USA", date: "201702/23"},
    { country: "UK", date: "2017/08/01"}
  ]
}
```

## 模式小结： 列转行

```lua
场景                             痛点                      设计模式方案及优点

产品属性 'color'             文档中有很多类似的字段           转化为数组，一个索引解决
'size', 'dimensions'         会用于组合查询搜索，需要        所有查询问题
...                          建很多索引

多语言（多国家）属性
```

## 模型灵活了，如何管理文档不同版本？

- 增加版本字段

## 如何统计网页点击流量

- 每访问一个页面都会产生一次数据库计数更新操作
- 统计数字准确性并不十分重要

- 解决方案： 用近似计算
  > 每隔 10(X)次写一次 Increment by 10(X)

## 业绩排名，游戏排名，商品统计等精确统计？

- 热销榜： 某个商品今天卖了多少？这个星期卖了多少？这个月卖了多少？
- 电影排行： 观影者，场次统计
- 传统解决方案： 通过聚合计算
- 痛点：消耗资源多，聚合计算时间长

- 解决方案： 用预聚合字段

```js
db.inventory.update(
  { _id: 123 },
  {
    $inc: {
      quantity: -1,
      daily_sales: 1,
      weekly_sales: 1,
      monthly_sales: 1,
    },
  }
);
```

```lua
{
  product: "Bike",
  sku: "abc123456",
  quantity: 20394,
  daily_sales: 40,
  daily_sales: 302,
  monthly_sales: 1419
}
```
