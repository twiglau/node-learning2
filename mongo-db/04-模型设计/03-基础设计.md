# 基础设计

## MongoDB 文档模型设计三部曲

```lua

业务需求                                                        集合
   及      - - 逻辑导向 - - - >     基础建模     - - - - >       字段
逻辑模型                                                        基础形状



技术需求
读写比例，方式 - - 技术导向 - >      工况细化    - - - - >        引用及关联
及数量


经验和学习   - - 模式导向 - - >     套用设计模式 - - - - - >      最终模式
```

## 建立基础，文档模型

1. 根据概念模型或者业务需求推导出逻辑模型 -> 找到对象
2. 列出实体之间的关系(及基数) -> 明确关系
3. 套用逻辑设计原则来决定 内嵌方式 -> 进行建模
4. 完成基础模型构建

```lua

业务需求                                                        集合
   及      - - 逻辑导向 - - - >     基础建模     - - - - >       字段
逻辑模型                                                        基础形状

```

## 一个联系人管理应用的例子

1. 找到对象

```lua
- Contacts
- Groups
- Address
- Portraits
```

2. 明确关系

```lua
- 一个联系人有一个头像（ 1-1 )
- 一个联系人可以有多个地址 ( 1-N )
- 一个联系人可以属于多个组，一个组可以有多个联系人(N-N)
```

3. 图表

```lua

Contracts [name, company, title]
  |- - Groups [name] (N-N)
  |- - Addresses [type, street, city, state, zip_code] (1-N)
  |- - Portraits [mime_type, data] (1-1)
```

## 1-1 关系建模： portraits

1. 基本原则：

- 一对一关系以内嵌为主，作为子文档形式，或者直接在顶级不涉及到数据冗余。

2. 例外情况：

- 如果内嵌后导致文档大小超过 16MB

```lua
// Contacts
name: "TJ Tang",
company: "TAP",
title: "CTO",
portraits: {
  mimetype: "xxx",
  data: "xxx"
}
```

## 1-N 关系建模： Addresses

1. 基本原则

- 一对多关系同样以内嵌为主，用数组来表示一对多，不涉及到数据冗余

2. 例外情况

- 内嵌后导致文档大小超过 16MB,数组长度太大（数万或更多），数组长度不确定

```lua
// Contacts
name: "TJ Tang",
company: "TAP",
title: "CTO",
portraits: {
  mimetype: "xxx",
  data: "xxx"
},
addresses: [
  {type: "home"},
  {type: "works"}
]
```

## N-N 关系建模： 内嵌数组模式

1. 基本原则

- 不需要映射表，一般用内嵌数组来表示 一对多。通过冗余来实现 N-N

2. 例外情况

- 内嵌后导致文档大小超过 16MB,
- 数组长度太大（数万或更多）
- 数组长度不确定

```lua
// Contacts
name: "TJ Tang",
company: "TAP",
title: "CTO",
portraits: {
  mimetype: "xxx",
  data: "xxx"
},
addresses: [
  {type: "home"},
  {type: "works"}
]，
groups: [
  {name: "Friends"},
  {name: "Surfers"}
]
```
