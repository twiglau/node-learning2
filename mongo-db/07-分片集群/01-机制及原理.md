# 机制和原理

## MongoDB 常见部署架构

```lua
                                                              Mongos
                                               |                 |                   |
                                            Shard1            Shard2              ShardN
                                    |                   |                  |                     |
           |                        |      Primary      |     Primary      |      Primary        |
           |      Primary           |      Secondary    |     Secondary    |      Secondary      |
           |      Secondary         |      Secondary    |     Secondary    |      Secondary      |
           |      Secondary         |                   |                  |                     |
           |                        |
  Primary  |                        |
           |                        |
  单机版    |   复制集               |     分片集群
  开发与    |   高可用               |     横向扩展
  测试      |   70%                 |      10%
  20%
```

## 为什么要使用 分片集群？

- 数据容量日益增大，访问性能日渐降低，怎么处理？
- 新品上线异常火爆，如何支撑更多的并发用户？
- 单库已有 10TB 数据，恢复需要 1~2 天，如何加速？
- 地理分布数据

## 分片如何解决？

- 把数据分成四部分，放到四个物理库里。

1. 路由节点 mongos

- 路由节点： 提供集群单一入口，转发应用端请求。选择合适数据节点进行读写，合并多个数据节点的返回。
  > 无状态： 建议至少 2 个。

2. 配置节点 mongod

- 配置（目录）节点：提供集群元数据存储分片数据分布的映射

3. 数据节点 mongod

- 数据节点： 以复制集为单位，横向扩展，最大 1024 分片。分片之间数据不重复，所有分片在一起才可以完整工作。

## 分片集群特点

- 应用全透明，无特殊处理
- 数据自动均衡
- 动态扩容，无须下线
- 提供三种分片方式

## 分片集群数据分布方式

- 基于范围
- 基于 Hash
- 基于 zone / tag
