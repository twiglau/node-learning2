# 搭建复制集

本实验，通过在一台机器上，运行 3 个实例来搭建一个最简单的复制集。

1. 如何启动一个 MongoDB 实例；
2. 如果将 3 个 MongoDB 实例搭建成一个复制集。
3. 如果对复制集运行参数做一些常规调整。

## 准备工作

1. Windows 系统，需实现配置好 Mongo 可执行文件的环境变量
2. Linux 和 Mac 系统，配置 PATH 变量
3. 有 10G 以上的硬盘空间

## 创建数据目录

MongoDB 启动时将使用一个数据目录存放所有数据文件。我们将为 3 个复制集节点创建
各自的数据目录。

1. Linux/MacOS:

   > mkdir-p /data/db{1,2,3}

2. Windows:

```sh
md c:\data\db1
md c:\data\db2
md c:\data\db3
```

## 准备配置文件

复制集的某个 mongod 进程应该位于不同的服务器。 我们现在在一台机器上运行 3 个进程，因此要为他们各自配置：

1. 不同的端口。 使用：28017/28018/28019
2. 不同数据目录。
   /data/db1 或 c:\data\db1
   /data/db2 或 c:\data\db2
   /data/db3 或 c:\data\db3
3. 不同日志文件路径。
   /data/db1/mongod.log 或 c:\data\db1\mongod.log

4. Linux/MacOS

```conf
# /data/db1/mongod.conf
systemLog:
  destination: file
  path: /data/db1/mongod.log # log path
  logAppend: true
storage:
  dbPath: /data/db1 # data directory
net:
  bindIp: 0.0.0.0
  port: 28017 # port
replication:
  replSetName: rs0
processManagement: # window上不支持 fork,需要注释
  fork: true
```

## 启动多个实例

```sh
mongod -f /mongodb/28017/conf/mongod.conf
mongod -f /mongodb/28018/conf/mongod.conf
mongod -f /mongodb/28019/conf/mongod.conf
mongod -f /mongodb/28020/conf/mongod.conf
```

```sh
mongod -f c:\data\db1\mongod.conf
```

- 因为 Windows 不支持 fork, 以上命令需要在 3 个不同的窗口执行，执行后不可关闭窗口，否则进程将直接结束

## 查看起否启动成功

```sh
ps -ef | grep  mongod
```

```sh
tasklist | findstr "mongod"
netstat -ano
netstat -ano|findstr 280

TCP    0.0.0.0:28017          0.0.0.0:0              LISTENING       10628
TCP    0.0.0.0:28018          0.0.0.0:0              LISTENING       2708
TCP    0.0.0.0:28019          0.0.0.0:0              LISTENING       17360
```

## 配置复制集

```sh
mongosh --port 28017
mongosh localhost:28017


# 方法一：
# 注意：此方式 hostname 需要能被解析
rs.initiate()
rs.status()
rs.add("HOSTNAME:28018")
rs.add("HOSTNAME:28019")

# 方法二：
rs.initiate({
  _id: "rs0",
  members: [
    {
      _id: 0,
      host: "localhost:28017"
    },
    {
      _id: 1,
      host: "localhost:28018"
    },
    {
      _id: 2,
      host: "localhost:28019"
    }
  ]
})

# 方法三： 更改host地址
conf = rs.conf()
conf.members[0].host = 'localhost:28017'

# 注意：如何报错
# Either all host names in a replica set configuration must be localhost references, or none must be; found 2 out of 3

# 1. 需要先删除集群其他非主节点
rs.remove("localhost:28018")
# 2. 然后再更改主节点
conf = rs.conf()
conf.members[0].host = '192.168.5.9:28017'
rs.reconfig(conf)

# 3. 再添加集群子节点
rs.add({_id: 1, host: '192.168.5.9:28018', priority: 1})
rs.add({_id: 1, host: '192.168.5.9:28019', priority: 1, arbiterOnly: true})

# 注意： 如果报错
# Our set name did not match that of the request target
# 原因： mongod.conf 配置文件中， 确保所有节点的 replSetName 属性具有相同的名称:。
```

## 验证

1. MongoDB 主节点进行写入

```sh
mongo localhost:28017
> db.test.insert({ a: 1 })
> db.test.insert({ a: 2 })
```

2. MongoDB 从节点进行读

```sh
mongo localhost:28018

# 当前连接的是一个 secondary, 不是 primary.
# 而且这个secondary没有开启 rs.slaveOk(),也就是不允许直接读取 secondary 上的数据。
> rs.slaveOk()
> db.test.find()
> db.test.find()
```
