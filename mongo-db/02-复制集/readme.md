# 复制集 RS(ReplicationSet)

- 如果发生主库宕机，复制集内部会进行投票选举，选择一个新的主库替代原有主库对外提供服务。
  同时复制集会自动通知。客户端程序，主库已经发生切换了，应用就会连接到新的主库；
- MongoDB 复制集的主要意义在于实现服务 高可用。
  它的现实依赖于两个方面的功能：

1. 数据写入时将数据迅速复制到另一个独立节点上
2. 在接受写入的节点发生故障时，自动选举出一个新的替代节点。

## 特点

- 在实现高可用的同时，复制集实现了其他几个附加作用：

1. 数据分发：将数据从一个区域复制到另一个区域，减少另一个区域的读延迟。
2. 读写分离：不同类型的压力分别在不同的节点上执行。
3. 异地容灾：在数据中心故障时候快速切换到异地。

## 典型复制集结构

- 一个典型的复制集由 3 个以上具有投票权的节点组成，包括：

1. 一个主节点(PRIMARY): 接受写入操作和选举时投票
2. 两个(或多个) 从节点(SECONDARY): 复制主节点上的新数据和选举时投票
3. 不推荐使用 Arbiter(投票节点)

## 数据是如何复制的？

1. 当一个修改操作，无论是插入，更新或删除，到达主节点时，它对数据的操作将被记录下来（经过一些必要的转换），
   这些记录被为 oplog.
2. 从节点通过在主节点上打开一个 tailable 游标不断获取新进入主节点的 oplog,并在自己的数据上回访，以此保持
   跟主节点的数据一致。

## 通过选举完成故障恢复

1. 具有投票权的节点之间两两互相发送心跳；
2. 当 5 次心跳未收到时判断为节点失联；
3. 如果失联的是主节点，从节点会发起选举，选出新的主节点；
4. 如果失联的是从节点，则不会产生新的选举；
5. 选举基于 RAFT 一致性算法 实现，选举成功的必要条件是大多数投票节点存活；
6. 复制集中最多可以有 50 个节点，但具有投票权的节点最多 7 个；

## 影响选举的因素

- 整个集群必须有大多数节点存活
- 被选举为主节点的节点必须：

1. 能够与多数节点建立连接
2. 具有较新的 oplog
3. 具有较高的优先级(如果有配置)

## 常见选项

1. 是否具有投票权(v 参数)：有则参与投票；
2. 优先级(priority 参数): 优先级越高的节点越优先称为主节点。优先级为 0 的节点无法成为主节点。
3. 隐藏(hidden 参数)：复制数据，但对应用不可见。隐藏节点可以具有投票权，但优先级必须为 0；
4. 延迟(slaveDelay 参数)：复制 n 秒之前的数据，保持与主节点的时间差。

## 复制集注意事项

- 关于硬件：

1. 因为正常的复制集节点都有可能成为 主节点，它们的地位是一样的，因此硬件配置上必须一致；
2. 为了保证节点不会同时宕机，各节点使用的硬件必须具有独立性。

- 关于软件：

1. 复制集各节点软件必须一致，以避免出现不可预知的问题。

- 增加节点不会增加系统写性能。
