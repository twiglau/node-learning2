# 写操作

## 什么是 writeConcern ?

writeConcern 决定一个写操作落到多少个节点上才算成功。writeConcern 的取值包括：

1. 0：发起写操作，不关心是否成功；
2. 1：集群最大数据节点数：写操作需要被复制到指定节点数才算成功；
3. majority: 写操作需要被复制到大多数节点上才算成功。

- 发起写操作的程序将阻塞到写操作到达指定的节点数为止

## 默认行为

- 3 节点复制集不作任何特定设置（默认值）

## w: "majority"

- 大多数节点确认模式

## w: "all"

- 全部节点确认模式

## j:true

writeConcern 可以决定写操作到达多少个节点才算成功，journal 则定义如何才算成功。取值包括：

- true: 写操作落到 journal 文件中才算成功；
- false: 写操作到达内存计算作成功；

## 实验

```sh
# 在复制集测试 writeConcern 参数
db.test.insert({ count: 1 }, { writeConcern: { w: "majority" } });
db.test.insert({ count: 1 }, { writeConcern: { w: 3 } });
db.test.insert({ count: 1 }, { writeConcern: { w: 4 } });

# 配置延迟节点，模拟网络延迟 （复制延迟）
conf=rs.conf()
conf.members[2].slaveDelay = 5
conf.members[2].priority = 0
rs.reconfig(conf)

# 观察复制延迟下的写入，以及timeout参数
db.test.insert({count: 1}, { writeConcern: { w: 3}});
db.test.insert({count: 1}, { writeConcern: { w: 3, wtimeout: 3000 }})
```

## 注意事项

1. 虽然多半数的 writeConcern 都是安全的，但通常只会设置 majority, 因为这是等待写入延迟时间最短的选择；
2. 不要设计 writeConcern 等于总节点数，因为一旦有一个节点故障，所有写操作都将失败；
3. writeConcern 虽然会增加写操作延迟时间，但并不会显著增加集群压力，因此无论是否等待，写操作最终都会复制到
   所有节点上。 设置 writeConcern 只是让写操作等待复制后，再返回而已；
4. 应对重要数据应用 { w: "majority" }, 普通数据可以应用 { w: 1} 以确保最佳性能；
