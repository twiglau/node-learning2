# 影响性能的因素

Node.js 的事件循环机制和 cluster 模式就是一种 Node.js 潜在的内在因素，而网络 I/O,
磁盘 I/O 以及其他内存句柄的一些问题，则是因为服务器的资源因素导致的性能问题

## CPU 密集性计算

在 Node.js 中有以下几种情况，会影响到主线程的运行，应该主动避免：

1. 大的数据循环。
   > 比如没有利用好 数据流， 一次性处理非常大的数组
2. 字符串处理转化
   > 比如加解密，字符串序列化等。
3. 图片，视频的计算处理
   > 比如对图片进行剪裁，缩放或者切割等。

- 这样就会因为某些用户的复杂运算，而影响到整个系统的请求处理，如果这种复杂运算占比用的 CPU 事件越久，那么就会导致请求堆积，而这就会进一步导致系统处于崩溃状态无法恢复。

## 网络 I/O

网络 I/O 中有 2 中相关的类型，同步阻塞 I/O 和 异步非阻塞 I/O;

1. 同步阻塞 I/O 的字面意思是： 发出网络请求后，需要等待返回后，再处理其他计算。
2. 异步非阻塞 I/O 就是发起网络 I/O 后，还可处理其他的计算，这也是为什么 Node.js 在
   处理网络 I/O 性能较高的原因。

- 假设有个功能需访问一个 API 的数据，Node.js 调用 API 就是一种网络 I/O;
  > 如果该 API 处理慢，那么则所有用户请求都被阻塞了
  > 如果异步的话，则无需等待处理，可以继续其他的运行。

```sh
curl -w "%{time_total}\n" -o /dev/null -s http://127.0.0.1:3000/v1/io

"2.028935"
```

- 对于 /v1/io 请求，如果要提升性能，应关注什么呢?

1. 通道复用
   > 比如现在每次访问 :4000/v1/cpu 时都会发起一个 TCP 到：3000/v1/io, 如果能够通道复用，
   > 减少 TCP 握手，那就可以提升该接口的性能，或将某些内部服务使用 UDP 来实现。
2. 增加缓存
   > 对于相同响应的返回数据，增加缓存处理，避免不必要的计算。对于上面的计算，我们完全可以缓存
   > 计算结果，这样来减少 网络 I/O.
3. 长链接链接池
   > 有些网络 I/O 是长链接的形式，比如 MySQL, Mamcached 或者 Redis, 为了避免排队使用 长链接
   > 的问题， 可以使用 链接池。 而由于 Redis 和 Node.js 是单线程非阻塞处理， 因此可以不用链接池。

- 网络 I/O 一般不影响主线程逻辑，往往网络 I/O 请求的服务是 瓶颈端， 从而影响 Node.js 中涉及该
  网络服务的请求。

## 集群服务

后台服务，一般都有集群的概念。无论是多机部署，还是单机（Node.js cluster 模式）

1. 多进程 cluster 模式

   - 大概在 2 万以上的并发时，master 进程会存在性能瓶颈
     > 在实际开发过程中，遇到问题，由于所用机器是一个 96 核以上的服务器。
     > 因此启用较多的 worker 进程，而主进程只有一个，在单机高并发时（2 万以上的每秒并发请求)
     > 导致 master 进程处理瓶颈，影响到服务性能，并且这时候会发现 worker 进程的 CPU 并没有
     > 压力。

2. 其他相关
   对于 Node.js 后台服务，不仅要考虑其本身性能影响, 更应考虑它对服务器资源竞争产生的性能影响, 比如： 毫无节制使用 服务器的内存或句柄。 都会导致服务器的异常。, 而服务器的异常，则从侧面影响到 Node.js 本身的特性。

   - 内存限制

     > 在 32 位服务器上 Node.js 的内存限制是 0.7G
     > 而在 64 位服务器上则是 1.4G
     > 这个限制主要因为 Node.js 的垃圾回收线程，在超过限制内存时，
     > 回收时长循环大于 1s, 从而影响性能问题。

   - 句柄限制
     - 句柄可简单理解为 一个 ID 索引，通过这个索引可访问到其他资源。比如说，文件句柄，网络 I/O 操作句柄等等，而一般服务器句柄都有上限。
     - 当 Node.js 没有控制好句柄，比如无限的打开文件并未关闭，会出现句柄泄漏问题。而这样会导致服务器异常。从而影响 Node.js 服务。
