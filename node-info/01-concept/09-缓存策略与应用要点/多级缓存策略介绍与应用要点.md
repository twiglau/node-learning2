# 多级缓存及其应用要点

应用 Node.js 实践开发一个多级缓存的库，进一步掌握缓存的应用要点

## 缓存概念

缓存时临时的一块存储空间，用于存放 访问频次较高的数据，用空间换响应速度，核心是减少用户对 数据库的查询压力。

1. 临时
   为避免存储空间的浪费，应该尽量设置数据缓存的时间，当过期时，自动销毁。

2. 存储空间
   一般选择读写性能较高的内存，有些会 应用 SSD 进一步提升性能。

3. 访问频次较高的数据
   为避免存储空间的浪费，尽量选择访问频次较高的数据，切莫将数据直接放入缓存。

4. 数据库的查询压力
   要将一些复杂数据库查询进行缓存，减少数据库访问压力，提升用户响应速度。

## 缓存问题

如果没有应用好缓存，将会 导致一些不可见或很难定位的 现网事故。
主要是三点： 缓存雪崩，缓存击穿 和 缓存穿透。

### 缓存雪崩

- 假设有一批数据是 通过定时服务 从 数据库写入缓存中，统一设置了过期时间，当时间节点到了，
  但由于某种原因，数据又没从数据库写入缓存，导致这是所有数据都前往数据库查询数据，引起
  数据查询压力，导致数据库并发过大而瘫痪，无法正常服务。

1. 避免所有数据都设置同一个过期时间节点， 应该按数据类型，数据更新时效性来设置。
2. 数据过期时间应大于数据更新节点时间。并考虑更新时长，同时增加更新失败异常告警提示。
3. 对于一些相对较高频次 或者 数据库查询压力较大的数据，可不设置过期的时间，主动从程序
   上来控制该数据的移除 或者 更替。

### 缓存穿透： 访问频次较高的数据

- 查询信息一直是空数据，空数据按理不属于访问频繁较高的数据，经过缓存，但缓存没有缓存该空数据
  那么直接穿透进去了数据库，虽然数据库查询也是空数据，但还需经过数据库的查询，这种现象就是击穿
  缓存直接前往数据库查询。

1. 过滤非正常请求数据。比如：一些从参数就可以知道为空的数据，可直接从程序上处理。
2. 缓存空的结果。为提升性能，将一些查询为空的结果缓存起来，这样下次用户再进行访问时，可直接从缓存
   中判断返回。
3. 第 2 中方案在空数据较多时，会浪费内存空间，可将空数据的键名用 Bloom Filter[布隆过滤器] 缓存到缓存，可尽可能
   减少内存占用，且更加高效。

### 缓存击穿

- 这个概念和缓存雪崩有点类似，但不是大面积缓存过期失效，而是某个访问频次较高，数据失效了。导致这一刻高并发的请求
  全部穿透到了 数据库，数据库并发压力较高，响应较慢，也进一步导致数据库异常。影响其他业务。

1. 高频数据，查询较为复杂的数据，可以不设置过期时间，但需要程序去维护数据的更替删除。
2. 如果需要缓存过期时间，要大于缓存更新时间，避免过期无法找到键。
3. 使用原子操作方案，当多个数据都需要前往数据库查询同一个数据时，告知程序正在生成中，且告知其他程序
   可以读取上一次缓存，数据避免同时读取同一份数据。

## 多级缓存： 本地缓存 + 共享缓存
