# CPU 过载保护设计： 如何在服务层面确保系统稳定？

## CPU 过载保护机制

- 长时间饱和工作状态，银行人员会很辛苦， 无法更好服务用户，一般情况下，在银行都会
  有一定的取号上限或保安会提示无法再服务了。- 这就是一个 过载的保护。 避免因事务积压
  导致系统无法提供更好的服务。
- 在 Node.js 中最大的瓶颈在于 CPU, 需要针对 CPU 的过载进行保护，当 CPU 使用率超出一定范围
  时，进行请求熔断处理，直接报错返回。

## 实现方案

1. 获取当前进程所在的 CPU 使用率的方法

- Node.js 进程启动后，都会绑定在单核 CPU 上， 假设机器有 2 个 CPU 内核，只启动了一个进程，在没有其他外的因素影响的情况下，Node.js
  即使跑满 CPU,也最多只占用了 50% 的总机器的 CPU 利用率。

```sh
ps -p ${process.pid} -o pid,rss,vsz,pcpu,comm

# pid  是进程 ID
# rss  是实际内存占用
# vsz  是虚拟内存占用
# pcpu 是CPU使用率
# comm 是进程执行的指令
```

2. 应尽量避免影响服务性能

- 由于在 Node.js 就只有一个主线程，因此必须严格减少框架在主线程的占用时间，控制框架基础模块的性能损耗。
  从而将主线程资源更多服务于业务，增强业务并发处理能力。

  2.1 只处理需要的数据，在第一步获取 CPU 使用率的基础上，需要缩减一些字段，只获取 CPU 信息即可。
  2.2 定时落地 CPU 信息到内存中，而非根据用户访问来实时计算。

3. 什么时候触发过载，能否减少错误处理情况
4. 请求丢弃方法和优先级

- 在获取 CPU 值后，可根据当前 CPU 的情况进行一些丢弃处理，但应尽量避免出现 误处理 的情况，比如当前 CPU
  某个时刻出现过高但立马回复了，这种情况下是不能进行丢弃请求的。只有当 CPU 长期处于一个高负载 情况下才能进行请求丢弃。
  4.1 overloadTimes: 直线型

  > 用 o 表示，指 CPU 过载持续次数，该值越高丢弃概率越大，设定取值范围为 0~10

  4.2 currentCpuPercentage： 指数型增长模型

  > 用 c 表示，指 CPU 当前负载越高，占用率越大丢弃概率越大，设定范围为 0~10

  4.3 baseProbability: 直线型

  > 用 b 表示，是负载最大时的丢弃概率，取值范围为 0~1.

  ```lua
  P = (0.1 * o) * Math.exp(c)/(10 * Math.exp(10)) * b
  ```

  > 其中 o 取最大值 100， c 取最大值 10， b 为固定值，这里假设 0.7,那么求出来的最大概率是 0.7
  > 那么在 o 为 30， c 为 90 的概率，则是 0.19， 因此会丢弃 19% 的用户请求。
