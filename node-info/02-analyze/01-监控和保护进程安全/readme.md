# 系统稳定：如何监控和保护进程安全

1. 在前端因为 某些用户的特殊性，导致 逻辑 Bug 造成这个 用户服务异常。但在 服务端，如果没有做好异常保护，某用户特殊操作可能导致整个进程退出，从而无法提供服务。
2. 在 Node.js 代码层面应该如何降低异常出现的概率，及当出现现网问题时，如何及时发现并通知相应的开发去处理。

## 哪些场景会导致 Node.js 异常？

1. 由于 Node.js 使用的是 JavaScript, 而 JavaScript 是一个弱类型语言，因此在现网经常会引发一些由代码逻辑的异常导致的进程异常退出。
2. 在 Node.js 中也经常会因为内存的使用不当，导致内存泄漏。当在 64 位系统中达到 1.4G (32 位系统 0.7G) 时，Node.js 会异常崩溃。
3. 再尔由于 Node.js 的 I/O 较多也较为频繁，当启用较多 I/O 句柄，但是没有及时释放，同样会引起进程问题。

- 从 代理逻辑 和 服务器异常 两个方面，介绍哪些场景会导致这些问题。并且应该如何去杜绝这类问题。演示一个搭建 Node.js 性能告警平台。
  解决告警通知机制

## Node.js error

- null.property
  data.str?.str, data[$str]?[$str], object?.forEach, for(let i=0;i<arr?.length;i++){},
  null.indexOf(), null.split();

  > JavaScript 是一个弱类型语言，如果对数据没有严格判断，就进行逻辑处理，会导致代码服务异常退出。
  > 从而影响用户体验。

  > 当数据结构非常复杂时，判断逻辑也会非常复杂，从而影响了开发效率，为了解决这个问题，可以使用
  > lodash 这个库的 get 方法。

- parameters error
  JSON.parse, fs, require

  > 关于 JSON.parse 大多时候，都比较自然地，将其他接口 或者 第三方的数据拿来解析，但往往会忽略非 JSON 字符串的问题。

  > Node.js 的 fs,在应用时，最好是使用 try...catch 进行异常处理，因为很多时候可能存在权限不足，或文件不存在等问题。

- other errors
  Promise.then().catch(err), Socket.on('error'), var/let

  > JavaScript 语法问题，由于 Node.js 是运行时，报错。因此语法问题也只会在运行期间被发现，比如常发现的同变量，重新申明的问题。特别是 let,var 声明同一个变量。

## 常见服务异常解析

主要是 内存泄漏，句柄泄漏，及网络模块调用。

- 全局变量

> 一般情况下，不建议使用全局变量。因为全局变量最容易引起内存泄漏问题。比如，将用户的 session 保存在一个全局变量中，随着用户越来越多，这个 session
> 变量保存的数据也会越来越大，而且没有清理的规则，即使有清理规则，清理时间长短影响用户体验。也影响内存大小。

> 日志模块，就是一个全局变量，这个全局变量必须要有一定的上线和清理规则，才能保证服务的安全。

- 单例模块中的变量

> 要注意一个点，有些模块使用单例的模式，在每次 require 后都返回这个对象，这种情况也比较容易，引发内存泄漏问题。

- 开发文件后，未主动关闭

> 一般打开文件句柄后，都应该主动关闭
> 如果未主动关闭，就会导致文件句柄越来越多，从而引发句柄泄漏问题。

> 在 Node.js 里 fs 的模块中，都提供了 打开文件句柄关闭的方法。
> 比如：fs.open 提供了 fs.close 方法，fs.createWriteStream 提供了 fileStream.end 的方法。

- 网络句柄

> 网络句柄超出的情况，一般还好。目标服务器会主动拒绝你的请求，但作为调用方，应该也要复用句柄。
> 主动避免这类问题，其次还要注意连接超时控制，特别是在使用 Node.js 第三方库 request 以及 Socket 模块时。

## 监控告警平台简单流程图

```lua


单台 Node.js 服务

                            Node.js 进程 -   |

                              定时采集     主动上报
                                             |
       本地 <-- 缓存本地  --   本地采集 <-

      定时上报同步

      数据处理服务  计算并落地 ->  [] - XXQL ->  告警平台


                                      触发告警   查询视图   API接口
```

- 自动定时采集进程的指标数据
- 接口被调用 或者 访问后， 主动上报的信息
- 监控数据处理经过一系列的复杂计算，按照一定数据要求落入监控平台的数据存储中，告警平台则使用特定 QL 语法查询数据库

1. 触发告警
   根据告警平台的设置，当数据落入后判断是否满足告警机制，满足则调用告警模块触发告警。
2. 查询视图
   这部分就是一个前端可交互的界面，用户可以在这个平台查询监控信息
3. API 接口
   有些情况针对告警进行一些研发操作，也支持 API 查询，监控告警信息。

## Node.js 有哪些告警平台，监控的指标有哪些？

### prometheus 官网搭建一套这种服务，对 Node.js 的支持是非常到位的，扩展请参考 GitHub prom-client 库

- 在业务警告方面可以直接：复用当前后台侧的业务告警系统，或 prometheus 也可以的，又或者目前常用的一套组合
  系统 Grafana(主要是监控系统界面操作平台) + InfluxDB(数据存储) + telegraf(数据采集) 也可以

### 监控指标

- 在进程控告警层面，要了解到底应该监控 Node.js 的哪些指标属性，其次在业务层面，我们又应该主动上报那些信息来
  作为监控指标。

1. 事件延迟
   因 Node.js 主要是事件循环，如果主线程被长时间占用，导致事件执行延迟，而最简单的办法就是：使用 setTimeout 判断，当
   设定 1000ms 执行某个事件，但真正开始执行的时间大于 1000ms,那就可能存在事件延迟了，如果这个延迟越来越长，就必须
   告警提示 开发者需要查看，是否有异常事件被卡主，或服务压力过大。
2. CPU 使用率
   这是一个非常重要的指标，当发现 CPU 使用率长期维持在 70% 以上，就要 考虑是否需要扩容，或者是增加进程的方式，来解决这个问题。
   如果长期在 100%,那肯定是需要扩容，或检查内部代码逻辑是否存在问题。
3. 内存变化
   Node.js 的内存泄漏是较为常见的，其最大的问题就是导致垃圾回收时间变长，从而影响 Node.js 的服务性能。最大的影响就是内存达到上限
   后进行重启，从而中断用户请求，引发在重启过程中的用户请求。
4. 句柄变化
   由于服务器的句柄是有上限的，如果无节制开启句柄，会导致系统性能损耗，从而影响进程的性能。因此必须在未使用句柄时，进行释放，如果长期
   不释放，就会在达到上限时，导致请求无法开启新的句柄。从而无法正常提供服务。
5. 进厂异常重启次数
   也是用来判断代理逻辑是否足够健壮的一个点，如果存在异常重启次数，那一定是代码中存在未 catch 住的异常，或者说上面提到内存泄漏上限
   问题。

### 在业务层面，主要是关心服务提供的 业务响应速度，需要把所有的接口按照以下指标惊醒上报。

1. 接口名称
   主要是用来区分接口的唯一性
2. 接口请求时的，服务器时间
   用来保留用户请求的事件节点
3. 接口的请求用户分类标识
   需根据设备，地区，网络运营商，版本信息等进行不同维度的数据统计，因此这部分需要依据自身业务惊醒上报。

### 监控指标

1. 接口请求耗时
   尽量细分，比如 Node.js 内部逻辑耗时，第三方接口耗时及一些存储服务的请求耗时，例如：Redis,MySQL,MongoDB 等。
2. 当前服务器 IP
   有些可能和服务器有关，比如：负载均衡未做好，导致部分机器分发请求过大，引起部分机器过载的问题。因此上报
   当前服务器的 IP，也是非常关键的点。
