# 登录，注册等鉴权

## 鉴权方式

- Session Cookie

1. 优点：
   较易扩展，简单
2. 缺点：
   安全性低，性能低，服务端存储，多服务器同步 session 困难，跨平台困难

- JWT

1. 优点：
   易扩展，支持移动设备，跨应用调用，安全，承载信息丰富
2. 缺点：
   刷新与过期处理，Payload 不易过大，中间人攻击

- Oauth

1. 优点：
   开放，安全，简单，权限指定
2. 缺点：
   需要增加授权服务器，增加网络请求

## JWT 功能

```sh
pnpm install @nestjs/jwt passport-jwt passport --save
pnpm install @types/passport-jwt --save-dev
```

- @nest/jwt 包是一个实用程序包，可以帮助 jwt 操作。
- passport-jwt 包是实现 jwt 策略的 Passport 包。
- Passport-local 策略提供的内置 AuthGuard 来装饰路由：

1. 只有在用户验证通过之后，才会调用路由处理程序。
2. req 参数将包含一个用户属性(在 passport-local 身份验证流期间的 Passport 填充)

## 图解

1. 从 payload -> JWT 的转化，解析
2. JWT -> 签名
3. JWT -> 校验

```lua
               /login
      |  - - - - - - - - - - - - >   |- - - - - - - - - - - -  -  - - -  - - -  - - - - - - - - - |
      |  Body {username,password}    | Pipe | - > | Controller | - > | Service | - > | Repository |
 前端  | < - - - - - - - - - - - -  - |
      |          data: JWT           |              密钥   - - - > | - - - - - - - |
      |           /user              |                             | |- - - - - |  |
      | - - - - - - -  - - - - - - ->|                             | | 签名     |  |
      |            Headers:          |                            passport |       |
      |   Authentication: JWT        |                             |       V       |
      | < - - - - - - - - - - - - - -|                             |  | - - - - -| |
      |        data: xxx             |                             |  |  JWT     | |
```

## 所有鉴权都通过 Auth 模块

```lua
                                                  Controller                Service
         |    请求        |     |- - - >       | AuthController | - - >   | AuthService |
         |    POST        | - - |                                               |
登录     |   /auth/signin  |     |             | UserController |         | UserService | - - >   | UserRepository |
                                 |
                                 |
         |   请求          |     |
注册     |   POST          | - - |
         |  /auth/signup   |
```

## AuthModule

```lua
                               AuthModule
   - - - - - - - - - - - -  - - - - - -  - - - - - - - - -  - - - - -
   |- - - - - - - - - -  - - - Providers - - - - - - - - - - - - -  |
   |  ConfigModule     PassportModule - - >  JwtModule              | - - - - - - - >   jsonwebtoken / sign()
   |- - - - - - - - - - - - -  - - - - - - - -  - - - - - - - - - - |     |
         |                    |              DI Container           |     | - - - - -> | - - - - - - - - - - - |
    ConfigService        JwtStrategy < - - - - - - - - |            |                  |passport/passport-jwt  |
                                                       |                               |- - - - - - - - - - -  |
                                                       |                               | | - - - - - - - - -|  |
                                                       | - - - - - validate - - - -    | |  verify          |  |
                                                                                       | | - - - - - - - - -|  |
                                                                                       | |  authenticate    |  |
                                                                                       | | - - - - - - - - -|  |
                                                                                       |- - - - - - - - -  - - |
```
